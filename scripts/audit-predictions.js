#!/usr/bin/env node

/**
 * AUDIT CRITIQUE DES PR√âDICTIONS ACTUELLES
 * 
 * Analyse d√©taill√©e des 7 pr√©dictions pour identifier les probl√®mes
 */

require('dotenv').config()
const fs = require('fs')
const path = require('path')

async function auditPredictions() {
    console.log('üîç AUDIT CRITIQUE PR√âDICTIONS USUTALODDS')
    console.log('=========================================')
    
    // 1. Charger les pr√©dictions
    const predictionsFile = path.join(__dirname, '..', 'predictions', 'predictions_2025-08-19.json')
    
    if (!fs.existsSync(predictionsFile)) {
        console.error('‚ùå Fichier pr√©dictions introuvable')
        return
    }
    
    const data = JSON.parse(fs.readFileSync(predictionsFile, 'utf-8'))
    const predictions = data.predictions
    
    console.log(`üìä ${predictions.length} pr√©dictions √† analyser`)
    console.log(`‚è∞ G√©n√©r√©es le: ${new Date(data.generated_at).toLocaleString('fr-FR')}\n`)
    
    // 2. Analyse globale
    console.log('üìà ANALYSE GLOBALE')
    console.log('==================')
    
    const globalStats = analyzeGlobalStats(predictions)
    displayGlobalStats(globalStats)
    
    // 3. Analyse par match
    console.log('\n‚öΩ ANALYSE D√âTAILL√âE PAR MATCH')
    console.log('==============================')
    
    predictions.forEach((pred, index) => {
        console.log(`\nüèüÔ∏è  MATCH ${index + 1}: ${pred.match_info.home_team_name} vs ${pred.match_info.away_team_name}`)
        analyzeMatch(pred)
    })
    
    // 4. Probl√®mes identifi√©s
    console.log('\nüö® PROBL√àMES IDENTIFI√âS')
    console.log('========================')
    identifyProblems(predictions)
    
    // 5. Recommandations
    console.log('\nüí° RECOMMANDATIONS CRITIQUES')
    console.log('=============================')
    generateRecommendations()
}

function analyzeGlobalStats(predictions) {
    const stats = {
        totalMatches: predictions.length,
        avgHomeWin: 0,
        avgDraw: 0,
        avgAwayWin: 0,
        avgConfidence: 0,
        avgOver25: 0,
        domicileAdvantageCount: 0,
        equilibreCount: 0,
        exterieurAdvantageCount: 0,
        homeWinPredictions: 0,
        drawPredictions: 0,
        awayWinPredictions: 0
    }
    
    predictions.forEach(pred => {
        const p1x2 = pred.prediction.result_1x2
        const goals = pred.prediction.total_goals
        const analysis = pred.prediction.analysis
        
        stats.avgHomeWin += p1x2.home_win
        stats.avgDraw += p1x2.draw
        stats.avgAwayWin += p1x2.away_win
        stats.avgConfidence += analysis.overall_confidence
        stats.avgOver25 += goals.over_2_5
        
        // Avantage tactique
        if (analysis.matchup_analysis.avantage_tactique === 'domicile') stats.domicileAdvantageCount++
        else if (analysis.matchup_analysis.avantage_tactique === 'exterieur') stats.exterieurAdvantageCount++
        else stats.equilibreCount++
        
        // Pr√©diction favorite
        if (p1x2.home_win > p1x2.draw && p1x2.home_win > p1x2.away_win) stats.homeWinPredictions++
        else if (p1x2.away_win > p1x2.draw) stats.awayWinPredictions++
        else stats.drawPredictions++
    })
    
    // Moyennes
    stats.avgHomeWin = (stats.avgHomeWin / predictions.length * 100).toFixed(1)
    stats.avgDraw = (stats.avgDraw / predictions.length * 100).toFixed(1)
    stats.avgAwayWin = (stats.avgAwayWin / predictions.length * 100).toFixed(1)
    stats.avgConfidence = (stats.avgConfidence / predictions.length).toFixed(1)
    stats.avgOver25 = (stats.avgOver25 / predictions.length * 100).toFixed(1)
    
    return stats
}

function displayGlobalStats(stats) {
    console.log(`üìä Moyennes 1X2: ${stats.avgHomeWin}% - ${stats.avgDraw}% - ${stats.avgAwayWin}%`)
    console.log(`üéØ Confiance moyenne: ${stats.avgConfidence}%`)
    console.log(`‚öΩ Moyenne Over 2.5: ${stats.avgOver25}%`)
    console.log(`üè† Victoires domicile pr√©dites: ${stats.homeWinPredictions}/${stats.totalMatches}`)
    console.log(`ü§ù Nuls pr√©dits: ${stats.drawPredictions}/${stats.totalMatches}`)
    console.log(`‚úàÔ∏è  Victoires ext√©rieur pr√©dites: ${stats.awayWinPredictions}/${stats.totalMatches}`)
    console.log(`‚öñÔ∏è  Avantages tactiques: Dom ${stats.domicileAdvantageCount} | √âqui ${stats.equilibreCount} | Ext ${stats.exterieurAdvantageCount}`)
}

function analyzeMatch(pred) {
    const p1x2 = pred.prediction.result_1x2
    const goals = pred.prediction.total_goals
    const homeAnalysis = pred.prediction.analysis.home_analysis
    const awayAnalysis = pred.prediction.analysis.away_analysis
    const matchupAnalysis = pred.prediction.analysis.matchup_analysis
    
    // Pr√©diction favorite
    let favorite = ''
    let favoriteProb = 0
    if (p1x2.home_win > p1x2.draw && p1x2.home_win > p1x2.away_win) {
        favorite = 'DOMICILE'
        favoriteProb = (p1x2.home_win * 100).toFixed(1)
    } else if (p1x2.away_win > p1x2.draw) {
        favorite = 'EXT√âRIEUR'
        favoriteProb = (p1x2.away_win * 100).toFixed(1)
    } else {
        favorite = 'NUL'
        favoriteProb = (p1x2.draw * 100).toFixed(1)
    }
    
    console.log(`   üìÖ ${new Date(pred.match_info.date).toLocaleDateString('fr-FR')}`)
    console.log(`   üéØ Favori pr√©dit: ${favorite} (${favoriteProb}%)`)
    console.log(`   üìä 1X2: ${(p1x2.home_win*100).toFixed(1)}% - ${(p1x2.draw*100).toFixed(1)}% - ${(p1x2.away_win*100).toFixed(1)}%`)
    console.log(`   ‚öΩ Over 2.5: ${(goals.over_2_5*100).toFixed(1)}%`)
    console.log(`   üîç Confiance: ${pred.prediction.analysis.overall_confidence}%`)
    console.log(`   ‚öñÔ∏è  Avantage: ${matchupAnalysis.avantage_tactique}`)
    
    // Analyses d'√©quipes
    console.log(`   üè† ${pred.match_info.home_team_name}: ${homeAnalysis.style_tactique} | ${homeAnalysis.forme_actuelle} | Forces: ${homeAnalysis.forces.length}`)
    console.log(`   ‚úàÔ∏è  ${pred.match_info.away_team_name}: ${awayAnalysis.style_tactique} | ${awayAnalysis.forme_actuelle} | Forces: ${awayAnalysis.forces.length}`)
    
    // Cotes implicites approximatives (pour comparaison)
    const homeOdds = (1 / p1x2.home_win).toFixed(2)
    const drawOdds = (1 / p1x2.draw).toFixed(2)
    const awayOdds = (1 / p1x2.away_win).toFixed(2)
    console.log(`   üí∞ Cotes implicites: ${homeOdds} - ${drawOdds} - ${awayOdds}`)
}

function identifyProblems(predictions) {
    const problems = []
    
    // 1. Biais domicile excessif
    const homeWinCount = predictions.filter(p => 
        p.prediction.result_1x2.home_win > p.prediction.result_1x2.draw && 
        p.prediction.result_1x2.home_win > p.prediction.result_1x2.away_win
    ).length
    
    if (homeWinCount === predictions.length) {
        problems.push('üö® BIAIS DOMICILE EXCESSIF: 100% des pr√©dictions favorisent le domicile')
    }
    
    // 2. Confiance uniforme suspecte
    const confidences = predictions.map(p => p.prediction.analysis.overall_confidence)
    const uniqueConfidences = [...new Set(confidences)]
    if (uniqueConfidences.length === 1) {
        problems.push(`üö® CONFIANCE UNIFORME: Toutes les pr√©dictions ont ${confidences[0]}% de confiance`)
    }
    
    // 3. Analyses d'√©quipe trop g√©n√©riques
    const genericAnalyses = predictions.filter(p => {
        const homeForces = p.prediction.analysis.home_analysis.forces.length
        const awayForces = p.prediction.analysis.away_analysis.forces.length
        return homeForces <= 1 || awayForces <= 1
    }).length
    
    if (genericAnalyses > predictions.length / 2) {
        problems.push('üö® ANALYSES G√âN√âRIQUES: >50% des √©quipes ont ‚â§1 force identifi√©e')
    }
    
    // 4. Buteurs identiques
    const firstPredScorers = predictions[0].prediction.probable_scorers.home
    const identicalScorers = predictions.every(p => 
        JSON.stringify(p.prediction.probable_scorers.home) === JSON.stringify(firstPredScorers)
    )
    
    if (identicalScorers) {
        problems.push('üö® BUTEURS G√âN√âRIQUES: Probabilit√©s identiques pour tous les matchs')
    }
    
    // 5. Over/Under peu vari√©
    const over25Values = predictions.map(p => Math.round(p.prediction.total_goals.over_2_5 * 100))
    const over25Range = Math.max(...over25Values) - Math.min(...over25Values)
    
    if (over25Range < 30) {
        problems.push(`üö® OVER/UNDER PEU VARI√â: √âcart de seulement ${over25Range}% entre matchs`)
    }
    
    // 6. Facteurs cl√©s r√©p√©titifs
    const allFactors = predictions.flatMap(p => p.prediction.analysis.key_factors)
    const factorCounts = {}
    allFactors.forEach(factor => {
        factorCounts[factor] = (factorCounts[factor] || 0) + 1
    })
    
    const repetitiveFactors = Object.entries(factorCounts)
        .filter(([factor, count]) => count > predictions.length * 0.6)
        .map(([factor, count]) => `"${factor}" (${count}/${predictions.length})`)
    
    if (repetitiveFactors.length > 0) {
        problems.push(`üö® FACTEURS R√âP√âTITIFS: ${repetitiveFactors.join(', ')}`)
    }
    
    // Afficher les probl√®mes
    if (problems.length === 0) {
        console.log('‚úÖ Aucun probl√®me critique d√©tect√©')
    } else {
        problems.forEach((problem, index) => {
            console.log(`${index + 1}. ${problem}`)
        })
    }
}

function generateRecommendations() {
    console.log('1. üéØ CALIBRATION PROBABILIT√âS')
    console.log('   - Revoir calculs Poisson avec vraies stats √©quipes')
    console.log('   - Ajuster avantage domicile selon performances r√©elles')
    console.log('   - Int√©grer variance selon forme r√©cente')
    
    console.log('\n2. üìä ENRICHISSEMENT FEATURES')
    console.log('   - Utiliser vraiment toutes colonnes team_features disponibles')
    console.log('   - Int√©grer donn√©es H2H historiques')
    console.log('   - Prendre en compte m√©t√©o, absences, calendrier')
    
    console.log('\n3. ü§ñ ANALYSE CONTEXTUELLE')
    console.log('   - Diff√©rencier analyses selon vraies caract√©ristiques √©quipes')
    console.log('   - Personnaliser buteurs probables par √©quipe')
    console.log('   - Ajuster confiance selon qualit√© donn√©es disponibles')
    
    console.log('\n4. üé≤ DIVERSIFICATION PR√âDICTIONS')
    console.log('   - √âviter biais syst√©matique faveur domicile')
    console.log('   - Varier Over/Under selon styles tactiques')
    console.log('   - Identifier vraies opportunit√©s de surprise')
    
    console.log('\n5. üìà VALIDATION')
    console.log('   - Backtesting sur 100 matchs historiques')
    console.log('   - Comparaison avec cotes bookmakers')
    console.log('   - M√©triques: accuracy, Brier score, calibration')
}

// Ex√©cution
auditPredictions().catch(console.error)